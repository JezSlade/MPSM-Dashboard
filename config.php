<?php
// config.php

$available_widgets = [];
$widget_directory = __DIR__ . '/widgets/'; // Path to the widgets folder

// Define the path for persistent dashboard settings
// This file will store settings in JSON format
define('DASHBOARD_SETTINGS_FILE', __DIR__ . '/dashboard_settings.json');


// Check if the directory exists
if (is_dir($widget_directory)) {
    // Scan the directory for PHP files
    $widget_files = glob($widget_directory . '*.php');

    foreach ($widget_files as $file_path) {
        // Temporarily include the file to get its configuration
        // This is done in a function scope to avoid variable collisions
        $widget_config = (function($file) {
            $_widget_config = []; // Initialize to ensure it's set
            ob_start();          // Start output buffering
            include $file;       // Include the widget file to get its $_widget_config
            ob_end_clean();      // Discard any output generated by the included file
            return $_widget_config;
        })($file_path);

        // Extract widget ID from filename (e.g., stats.php -> stats)
        $widget_id = basename($file_path, '.php');

        // Check if the widget config is valid and contains necessary info
        // and ignore the template.php file as it's not a real widget
        if (!empty($widget_config) && isset($widget_config['name'], $widget_config['icon']) && $widget_id !== 'template') {
            $available_widgets[$widget_id] = [
                'name' => $widget_config['name'],
                'icon' => $widget_config['icon'],
                'width' => $widget_config['width'] ?? 1, // Default to 1 if not specified
                'height' => $widget_config['height'] ?? 1 // Default to 1 if not specified
            ];
        } else if ($widget_id === 'template') {
            // Log that the template was ignored, useful for debugging
            error_log("INFO: config.php - Ignoring template widget file: '{$file_path}'");
        }
        else {
            error_log("Warning: Widget file '{$file_path}' does not contain valid \$_widget_config.");
        }
    }
} else {
    error_log("Error: Widgets directory not found at '{$widget_directory}'");
}
