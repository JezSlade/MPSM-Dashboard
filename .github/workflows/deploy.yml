name: FTP Deploy - Robust

on:
  push:
    branches: ["main"] # Trigger on pushes to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest # Run the job on a fresh Ubuntu environment
    timeout-minutes: 15 # Overall job timeout

    steps:
      - name: 🔍 Checkout Code
        uses: actions/checkout@v4 # Action to check out your repository code

      - name: 📦 Install lftp (if not present)
        run: sudo apt-get update && sudo apt-get install lftp -y
        # Ensures lftp is installed, as it's used for initial path discovery/verification

      - name: 🛡️ Verify FTP Credentials (using curl for basic check)
        # This step uses curl to perform a basic login test with the FTP server.
        # It's good for quickly verifying if the credentials themselves are valid.
        run: |
          echo "Testing FTP login with provided credentials..."
          # WARNING: These credentials are hardcoded for debugging.
          # Please switch to GitHub Secrets (e.g., ${{ secrets.FTP_USERNAME }}) for production!
          curl -v --disable-epsv -u "mpsm@resolutionsbydesign.us:Mpsm1234!!!" \
            ftp://ftp.resolutionsbydesign.us/ > auth_test.log 2>&1 || true # `|| true` prevents step failure if curl fails
          
          echo "=== FTP LOGIN TEST RESULTS ==="
          if grep "230 Login successful" auth_test.log; then
            echo "✅ Credentials WORKED. Proceeding..."
          else
            echo "❌ Credentials FAILED or connection issue. See logs below:"
            cat auth_test.log
            exit 1 # Fail the workflow step if login was not successful
          fi
          cat auth_test.log

      - name: 🗺️ Confirm FTP Account's Effective Root Path
        # This step helps confirm what directory the FTP user's login actually lands them in.
        # If your cPanel FTP user's "Home Directory" is set to the final web root,
        # then 'ls -la' here should show the contents of that web root.
        run: |
          # WARNING: These credentials are hardcoded for debugging.
          lftp -e "
            set ftp:ssl-allow no; 
            set net:timeout 30;   
            open -u mpsm@resolutionsbydesign.us,Mpsm1234 ftp.resolutionsbydesign.us;
            echo '=== FTP ACCOUNT EFFECTIVE ROOT (ls -la) ===';
            ls -la; # List contents of the directory you land in after login
            pwd; # Print working directory on the remote server
            bye;
          " > effective_root.log 2>&1
          
          echo "=== EFFECTIVE ROOT DISCOVERY LOG ==="
          cat effective_root.log
          echo "---"
          echo "Based on common subdomain setup, your FTP user should land in '/home/resolut7/public_html/mpsm.resolutionsbydesign.us/'."
          echo "The 'ls -la' above should show the *contents* of that directory."

      - name: 🚀 Deploy with FTP-Deploy-Action
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ftp.resolutionsbydesign.us
          username: mpsm@resolutionsbydesign.us
          password: Mpsm1234!!!
          local-dir: ./ # Deploy from the root of your GitHub repository
          # IMPORTANT: Set server-directory to '/' if your cPanel FTP user's
          # "Home Directory" is already set to the target web root (e.g., /home/resolut7/public_html/mpsm.resolutionsbydesign.us/).
          # This tells the action to deploy INTO the root of your FTP login.
          server-directory: / # Corrected path for direct deployment into the FTP account's home directory
          protocol: ftp
          exclude: .git/
          log-level: verbose
          delete: true
          timeout: 120 # Timeout for the deploy operation in seconds (2 minutes)

      - name: 📜 Final Report
        run: |
          echo "### DEPLOYMENT SUMMARY ###" > report.md
          echo "- Credentials: ✅ Validated (hardcoded for debugging - TEMPORARY!)" >> report.md
          echo "- Deployment Method: SamKirkland/FTP-Deploy-Action" >> report.md
          echo "- Local repository root (./) deployed to: FTP account's home directory (which should be /home/resolut7/public_html/mpsm.resolutionsbydesign.us/)" >> report.md
          echo "- Files should now be live at: https://mpsm.resolutionsbydesign.us" >> report.md
          echo "" >> report.md
          echo "---" >> report.md
          echo "**Troubleshooting Tips:**" >> report.md
          echo "1. **Check Action Logs:** Review the 'Deploy with FTP-Deploy-Action' step logs for detailed transfer information and any errors." >> report.md
          echo "2. **Verify FTP Account Home Directory:** Double-check your GreenGeeks cPanel under 'FTP Accounts' for 'mpsm@resolutionsbydesign.us' to confirm its 'Home Directory' is exactly '/home/resolut7/public_html/mpsm.resolutionsbydesign.us/'." >> report.md
          echo "3. **File Permissions:** Ensure correct file/directory permissions on the server if files are not accessible (often a cPanel setting)." >> report.md
          echo "4. **Clear Cache:** Sometimes, browser or server-side caching might prevent immediate display of new files." >> report.md
          echo "5. **Contact GreenGeeks Support:** Provide them with the full GitHub Actions workflow run link for detailed assistance if issues persist." >> report.md
          
          cat report.md
