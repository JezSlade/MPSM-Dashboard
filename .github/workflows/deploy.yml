name: FTP Deploy - Testing Mode

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - Show files before upload
        run: |
          echo "=== CURRENT DIRECTORY STRUCTURE ==="
          ls -laR
          echo "=================================="

      - name: Bump version with validation
        id: bump_version
        run: |
          set -euo pipefail
          
          # Initialize version.txt if missing
          if [ ! -f version.txt ]; then
            echo "0.0.0.0" > version.txt
          fi

          # Validate version format
          if ! grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' version.txt; then
            echo "::error::Invalid version format in version.txt"
            exit 1
          fi

          # Increment version
          IFS='.' read -r MAJOR MINOR PATCH BUILD < version.txt
          BUILD=$((BUILD + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}.${BUILD}"
          echo "$NEW_VERSION" > version.txt
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Version bumped to: $NEW_VERSION"

      - name: FTP Upload with verbose logging
        uses: sebastianpopp/ftp-action@releases/v2
        with:
          host: "ftp.resolutionsbydesign.us"
          user: "mpsm@resolutionsbydesign.us"
          password: "MP$M_Nr0lr"
          localDir: "./"
          remoteDir: "./"  # Try "public_html/" or "htdocs/" if this fails
          options: "--delete --transfer-all --verbose --exclude .git/"
        
      - name: Verify upload
        run: |
          echo "If you see this, the FTP upload completed without immediate errors"
          echo "Check your server for files. If missing:"
          echo "1. Your remoteDir path might be incorrect"
          echo "2. Your FTP user may not have write permissions"
          echo "3. The server might silently reject certain files"