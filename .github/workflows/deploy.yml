name: Simple FTP Deploy

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  deploy:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version
        run: |
          VERSION_FILE=version.txt
          if [ -f "$VERSION_FILE" ]; then
            VERSION=$(cat "$VERSION_FILE")
          else
            # initialize to 0.0.0.0 if missing
            VERSION="0.0.0.0"
          fi

          # split into four segments
          IFS='.' read -r MAJOR MINOR PATCH BUILD <<< "$VERSION"

          # ensure each is numeric
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          BUILD=${BUILD:-0}

          # increment the build (fourth) segment
          BUILD=$((BUILD + 1))

          NEW_VERSION="$MAJOR.$MINOR.$PATCH.$BUILD"
          echo "$NEW_VERSION" > "$VERSION_FILE"
          echo "Bumped version to $NEW_VERSION"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.txt
          git commit -m "Bump version to $(cat version.txt)" || echo "No changes to commit"
          git push

      - name: FTP Upload (clean mirror)
        uses: sebastianpopp/ftp-action@releases/v2
        with:
          host:     ${{ secrets.FTP_SERVER }}
          user:     ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          localDir: "./"
          remoteDir: ${{ secrets.REMOTE_DIR }}
          options: "--delete"
