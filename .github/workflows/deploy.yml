name: FTP Deploy - Final Debug Mode

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: 🔍 Checkout Code
        uses: actions/checkout@v4

      - name: 🛡️ Verify FTP Credentials
        run: |
          echo "Testing FTP login with new password..."
          curl -v --disable-epsv -u "mpsm@resolutionsbydesign.us:Mpsm1234" \
            ftp://ftp.resolutionsbydesign.us/ > auth_test.log 2>&1
          
          echo "=== AUTH TEST RESULTS ==="
          grep "230 Login successful" auth_test.log && \
            echo "✅ Credentials WORK" || \
            (echo "❌ Credentials FAILED"; exit 1)
          cat auth_test.log

      - name: 🗺️ Discover Server Paths
        run: |
          lftp -e "
            set ftp:ssl-allow no;
            set net:timeout 15;
            open -u mpsm@resolutionsbydesign.us,Mpsm1234 ftp.resolutionsbydesign.us;
            echo '=== SERVER PATH STRUCTURE ===';
            ls -la;
            ls -la ~/public_html;
            ls -la /home/resolut7;
            bye;
          " > path_discovery.log 2>&1
          
          echo "=== PATH DISCOVERY ==="
          cat path_discovery.log

      - name: 🚀 Deploy with Verified Path
        run: |
          lftp -e "
            set ftp:ssl-allow no;
            set net:timeout 30;
            set xfer:log yes;
            open -u mpsm@resolutionsbydesign.us,Mpsm1234 ftp.resolutionsbydesign.us;
            
            echo 'Deploying to detected web root...';
            mirror --reverse \
                   --delete \
                   --verbose \
                   --exclude .git/ \
                   ./ /home/resolut7/public_html/resolutionsbydesign.us/;
            
            echo '=== DEPLOYMENT VERIFICATION ===';
            ls -la /home/resolut7/public_html/resolutionsbydesign.us/;
            bye;
          " > deploy.log 2>&1
          
          echo "=== DEPLOYMENT LOG ==="
          cat deploy.log

      - name: 📜 Final Report
        run: |
          echo "### DEPLOYMENT SUMMARY ###" > report.md
          echo "- Credentials: ✅ Working" >> report.md
          echo "- Deployed to: /home/resolut7/public_html/resolutionsbydesign.us/" >> report.md
          echo "- Files should appear at: https://resolutionsbydesign.us" >> report.md
          echo "" >> report.md
          echo "If files don't appear:" >> report.md
          echo "1. Check the path discovery output above" >> report.md
          echo "2. Contact host with this exact error" >> report.md
          
          cat report.md